---
title: å¦‚ä½•ä½¿ç”¨docker-composeæ­å»ºä¸ªäººgitlab
date: 2021-06-16
---

å‡†å¤‡ä¸€ä¸ª`docker-compse.yml`æ–‡ä»¶

```yaml
version: '3'

services:
  gitlab:
    image: gitlab/gitlab-ce
    container_name: gitlab
    restart: always
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://gitlab.shikun.info' # æŒ‡å®šå¤–éƒ¨åœ°å€ï¼Œåè®®ä¸ºhttps
        letsencrypt['enable'] = false # ä¸ä½¿ç”¨letsencryptç”³è¯·sslè¯ä¹¦ï¼Œå› ä¸ºæŒ‡å®šåè®®ä¸ºhttpsæ—¶ï¼Œgitlabä¼šè‡ªåŠ¨é€šè¿‡letsencryptç”³è¯·sslè¯ä¹¦
        nginx['listen_https'] = false # å› ä¸ºä¸ç”³è¯·sslè¯ä¹¦ï¼Œæ‰€ä»¥ä¸ç›‘å¬httpsåè®®ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥åœ¨gitlabé‡Œæ˜¾ç¤ºexternal_urlæŒ‡å®šçš„åè®®url
        nginx['listen_port'] = 80 # ç›‘å¬80ç«¯å£
    ports:
      - '80:80' # æŒ‡å®šæš´éœ²80ç«¯å£ï¼Œé€šè¿‡åå‘ä»£ç†å®ç°https
      - '22:22' # æŒ‡å®šæš´éœ²22ç«¯å£
    volumes:
      - './gitlab/config:/etc/gitlab' # é…ç½®æ–‡ä»¶ç›®å½•
      - './gitlab/logs:/var/log/gitlab' # æ—¥å¿—ç›®å½•
      - './gitlab/data:/var/opt/gitlab' # ç”Ÿæˆçš„æ•°æ®ç›®å½•

  gitlab-runner:
    container_name: gitlab-runner
    image: gitlab/gitlab-runner
    restart: always
    volumes:
      - './runner/config:/etc/gitlab-runner'
      - '/var/run/docker.sock:/var/run/docker.sock'
    depends_on:
      - gitlab # ä¾èµ–äºgitlabæœåŠ¡çš„å¯åŠ¨
```

```bash
sudo docker-compose up -d
```

é…ç½®`nginx`æœåŠ¡ç«¯ï¼Œä»£ç† `tcp` æµé‡ (proxy host)

- ip 127.0.0.1
- ç«¯å£ 80
- åè®® http
- ssl è¯ä¹¦
- åŸŸå gitlab.shikun.info

é…ç½®`nginx`æœåŠ¡ç«¯ï¼Œä»£ç† `ssh` æµé‡ (proxy stream)

- ip 127.0.0.1
- ç«¯å£ 22
- åè®® tcp+udp

æ¯”å¦‚åœ¨`nginxproxymanager`ä¸­ï¼Œadd proxy host

![Proxy Host](./proxy-host.png)

![Proxy Host SSL](./ssl.png)

![Proxy Strem](./stream.png)

è®¿é—®[`https://gitlab.shikun.info`](https://gitlab.shikun.info)å¯ä»¥çœ‹åˆ°æˆåŠŸæ­å»ºäº† gitlab æœåŠ¡ï¼Œæ­å–œ ğŸ‰

æœ€ç»ˆæˆæœ

![Gitlab](./gitlab.png)
